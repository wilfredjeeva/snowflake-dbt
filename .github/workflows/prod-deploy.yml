name: Deploy PROD (pre-prod branch) - Deploy only

on:
  push:
    branches:
      - "pre-prod"
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

defaults:
  run:
    working-directory: datahub_refinery

env:
  DBT_PROJECT_OBJECT_NAME: DATAHUB_DBT_MODELS

jobs:
  prod_deploy_only:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI + dbt
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade snowflake-cli dbt-core dbt-snowflake

      - name: Write Snowflake private key (from GitHub Environment secret)
        run: |
          echo "${ secrets.SNOWFLAKE_PRIVATE_KEY_B64 }" | base64 -d > $HOME/sf_key.p8
          chmod 600 $HOME/sf_key.p8

      - name: Configure Snowflake CLI connection (ci)
        run: |
          mkdir -p ~/.snowflake
          cat > ~/.snowflake/config.toml <<'EOF'
          default_connection_name = "ci"
          [connections.ci]
          account = "${ secrets.SNOWFLAKE_ACCOUNT }"
          user = "${ secrets.SNOWFLAKE_USER }"
          role = "${ secrets.SNOWFLAKE_ROLE }"
          warehouse = "${ secrets.SNOWFLAKE_WAREHOUSE }"
          database = "${ secrets.SNOWFLAKE_PROJECT_DB }"
          schema   = "${ secrets.SNOWFLAKE_PROJECT_SCHEMA }"
          authenticator = "SNOWFLAKE_JWT"
          private_key_path = "$HOME/sf_key.p8"
          EOF

      - name: Install dbt dependencies (packages)
        run: dbt deps
      - name: Deploy dbt project object to DBTCENTRAL.PROD_* schema (NO RUN in prod)
        run: |
          snow dbt deploy "${{ env.DBT_PROJECT_OBJECT_NAME }}" --source . --profiles-dir . --force -c ci

      - name: Auto-create PR to sync pre-prod â†’ main
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            const title = `Sync main after PROD deploy (${context.sha.substring(0,7)})`;
            const body  = `Auto PR created after successful PROD deploy (deploy-only).\n\n` +
              `Source: pre-prod\n` +
              `Target: main\n` +
              `Commit: ${context.sha}`;
            try {
              const pr = await github.pulls.create({
                owner,
                repo,
                head: "pre-prod",
                base: "main",
                title,
                body
              });
              core.info(`Created PR #${pr.data.number}`);
            } catch (e) {
              core.warning(`Could not create PR (it may already exist): ${e.message}`);
            }
