name: Deploy PREPROD (after TEST success)

on:
  workflow_run:
    workflows: ["Deploy TEST (test branch)"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  DBT_PROJECT_OBJECT_NAME: DATAHUB_DBT_MODELS

jobs:
  preprod_deploy_run:
    runs-on: ubuntu-latest
    environment: preprod
    # Only run if test workflow succeeded AND it ran from the 'test' branch
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'test' }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Snowflake CLI + dbt
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade snowflake-cli dbt-core dbt-snowflake

      - name: Write Snowflake private key (from GitHub Environment secret)
        run: |
          printf '%s' "${{ secrets.SNOWFLAKE_PRIVATE_KEY_B64 }}" | tr -d '\n' | base64 -d > $HOME/sf_key.p8
          chmod 600 $HOME/sf_key.p8

      - name: Configure Snowflake CLI connection (ci)
        run: |
          mkdir -p ~/.snowflake
          cat > ~/.snowflake/config.toml <<'EOF'
          default_connection_name = "ci"
          [connections.ci]
          account = "${{ secrets.SNOWFLAKE_ACCOUNT }}"
          user = "${{ secrets.SNOWFLAKE_USER }}"
          role = "${{ secrets.SNOWFLAKE_ROLE }}"
          warehouse = "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
          database = "${{ secrets.SNOWFLAKE_PROJECT_DB }}"
          schema   = "${{ secrets.SNOWFLAKE_PROJECT_SCHEMA }}"
          authenticator = "SNOWFLAKE_JWT"
          private_key_path = "/home/runner/sf_key.p8"
          EOF
          chmod 0600 ~/.snowflake/config.toml

      - name: Install dbt dependencies (packages)
        run: |
          cd datahub_refinery
          dbt deps --target preprod

      - name: Deploy dbt project object to DBTCENTRAL.PREPROD_DBTPROJECTNAME schema
        env:
          SNOWFLAKE_PREPROD_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_PREPROD_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        run: |
          snow dbt deploy "${{ env.DBT_PROJECT_OBJECT_NAME }}" --source datahub_refinery --profiles-dir datahub_refinery --default-target preprod --force

      - name: Execute dbt build in Snowflake (PREPROD) (includes tests)
        env:
          SNOWFLAKE_PREPROD_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_PREPROD_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        run: |
          snow dbt execute "${{ env.DBT_PROJECT_OBJECT_NAME }}" build --target preprod --select "path:models+"

      - name: Run dbt tests (airbnb bronze)
        env:
          SNOWFLAKE_PREPROD_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_PREPROD_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        working-directory: datahub_refinery
        run: |
          dbt test \
            --select "path:models/bronze_adf/airbnb+" \
            --target preprod \
            --no-fail-fast \
            --profiles-dir .
        continue-on-error: true # generate report even if some tests fail

      - name: Generate dbt test HTML report
        if: always()
        run: python scripts/dbt_report.py

      - name: Upload dbt test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt_test_report_preprod
          path: dbt_test_report.html
          if-no-files-found: warn

      - name: Upload dbt artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt_artifacts_preprod
          path: |
            datahub_refinery/target/manifest.json
            datahub_refinery/target/run_results.json
          if-no-files-found: ignore
